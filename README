# auto-borgbackups-tui üõ°Ô∏è

[![Version](https://img.shields.io/badge/Version-3.0.0--rc-green?style=for-the-badge&logo=git)](https://github.com/YOUR_USER/auto-borgbackups-tui/releases)
[![License](https://img.shields.io/badge/License-MIT-yellow?style=for-the-badge)](LICENSE)
[![Borg](https://img.shields.io/badge/Borg-Backup-blue?style=for-the-badge&logo=linux)](https://borgbackup.readthedocs.io/)

---

## Introducci√≥n

### ¬øQu√© es BorgTUI?

BorgTUI es un orquestador interactivo para backups, que hace m√°s accesible y confiables los respaldos en uno de los motores de backups m√°s potentes y probados en la actualidad (BorgBackups). Dise√±ado para la persona que desean o necesitan tener sus datos en seguros y respaldados, sea un PC personal, un servidor o cualquier otro dispositivo con un sistema Linux integrado. No es un ‚Äúponlo a correr y olv√≠date‚Äù: su prop√≥sito es que puedas operar, supervisar y confiar en que tus backups se realizan de forma segura. Puedes automatizar los backups y los chequeos, todo de forma simple e intuitiva. 

### ¬øPor qu√© se creo este proyecto?

Este proyecto nace de una lecci√≥n aprendida por la v√≠a dif√≠cil: **usar backups manual no es fiable.** Incluso contando con sistemas robustos y a√±os de informaci√≥n protegida, el trabajo del "d√≠a a d√≠a" es el m√°s vulnerable. Realizar copias de seguridad manualmente es tedioso y propenso al olvido. Un error accidental o un fallo de hardware pueden borrar semanas de progreso si el √∫ltimo respaldo o algun gestor de versiones no lo uncluia.


## ¬øQu√© diferencia este proyecto de otros gestores?

Hay mcuhas herramientas para gestionar backups, algunas Interfaz Grafica de Usuario (GUI), otras que solo existen en la Temrinal (CLI); unas que siguen una filosofia de "fire and gorget" (ejecuta y olvidate) con confianza ciega en el funcionamiento del sistema y en que las configuraciones sean validas, otras que usan motores distintos a Borg... pero entre tantas opciones, BorgTUI se enfoca en que el sistema sea accesible para el usuario, que de confianza, tranquilidad y que permita conocer en todo momento el estado del sistema mediante notificaciones o un panel central con Interfaz de usuario en la terminal, desde donde se pueda gestionar todo de forma facil y rapida; que podamos concoer que esta pasando, si hay algun problema, y que podamos resolver esos problemas o cambiar las configuraciones mediante unos menus simples e intuitivos. BorgTUI puede correr en practicamente cualquier dispositivo con un Sistema Linux integrado, sea un PC personal, o incluso en un servidor que no tiene interfaz gr√°fica. Adem√°s, el sistema esta dise√±ado de manera simple, intuitiva, facil de desarrollar y de mantener. Es adem√°s, un sistema libre y abierto para que cualquiera pueda unirse o sacarle provecho para gestionar sus proyectos y datos de manera segura y con la tranquilidad de tener su informaci√≥n bien respaldada.    

### Prop√≥sito

Los backups solo valen si sabes que funcionan. BorgTUI evita la falsa tranquilidad de procesos silenciosos que fallan en secreto: desde el primer momento el operador debe entender qu√© est√° pasando, recibir avisos claros cuando algo no funciona y disponer de herramientas sencillas para investigar y corregir problemas. La prioridad es garantizar confianza operacional, no solo ejecutar tareas en segundo plano.


### Pilares fundamentales

**Simple:** Configuraci√≥n y uso pensados para ser directos; menos fricci√≥n significa menos errores humanos.

* Una configuraci√≥n simple y facil de entender.

* Una logica del sistema enfocada en la simpleza funcional, con una documenatci√≥n ordenado y dividido por seccioen sy objetivos.

**Intuitivo:** Interfaz y mensajes dise√±ados para personas.

* Explicaciones legibles, consultas r√°pidas y una vista central que facilita la supervisi√≥n y la toma de decisiones.

* Cuenta con una interfaz de usuario en la terminal (TUI) par facilitar la interacci√≥n cone l sisrtema.

* Retroalimentaci√≥n constante y gumana para saber que pasa y por qu√©.

**Seguro / Resiliente:** 

* Usa de base un gestor de backups (**BorgBackup**) que es uno de los gestores de backups m√°s probados y potentes en la actualidad. Con un sistema no solo seguro y confiable, sino tambi√©n equilibrado y flexible en lo que refiere a: espacio, velocidad, compresi√≥n, encriptaci√≥n e integridad de los datos. 

* Comportamiento defensivo frente a errores humanos: cuando algo falla, el sistema informa de forma comprensible, registra lo ocurrido y facilita la correcci√≥n. 

* Incluye validaciones y correcciones de seguridad:  valida acceso a los datos por respaldar, configuraciones v√°lidas, comprobaci√≥n de espacio en disco antes de realizar los backups, manejo de valores de emergencia para pol√≠ticas de rotaci√≥n, frecuencia y compresi√≥n cuando estos datos no son v√°lidos o no s√© espec√≠fican.

* Puedes programar chequeos constantes para verificar la integridad de los datos y detectar lkos problemas a tiempo. Los discos y herramienats de almacenamiento con el tiempo pueden fallar. Las revisiones de integridad evitan cosas como necesitar datos de un repaldo y al intentar recupeararlos, ver que ya no es accesible porque el disco se deterioro y nadie se entero.


### Manejo de errores parciales (NO es un todo o nada)

BorgTUI NO aplica una regla de ‚Äútodo o nada‚Äù para la lista de archivos y directorios a respaldar. No pone en riesgo el 99% de tus datos por un 1% inaccesible. Si un backup incluye, por ejemplo, 10 directorios y uno no es accesible, BorgTUI realiza el respaldo de los 9 directorios que s√≠ est√°n disponibles y marca claramente el directorio faltante. Esa informaci√≥n queda registrada en los logs, se muestra en la TUI y, si est√° configurado, se notifica al operador. De esta forma:

* No pierdes los archivos y directorios validos del respaldo por uno o varios archivos/directorios especificos con problemas (permisos, nombre mal escrito);

* Sabes exactamente qu√© falt√≥ y por qu√©, sin revisar manualmente cada archivo o directorio;

* Puedes relizar la correcci√≥n (permisos, rutas mal escritas, etc.) antes de un siguiente job cr√≠tico.

**Los directorios y archivos individuales si son un todo o nada:** el motor BorgBackups si usa la politica de "todo o nada" en los backups, si ocurre un problema en la creaci√≥n del backup, el backup no se crea incompleto, solo se crean los backus si todo sale bien. 


### Enfoque de dise√±o

* BorgTUI automatiza las tareas que deben automatizarse, pero evita la automatizaci√≥n ciega: favorece la transparencia, la trazabilidad y la rapidez para diagnosticar y corregir problemas. Los backups se ejecutan autom√°ticamente, registran su actividad y notifican al usuario cuando se requiere atenci√≥n.

* Los procedimiento sencibles como la reparaci√≥n del repositorio NO se automatizan, eso debe hacerse manualmente por ejemplo desde la TUI. Esto para evitar da√±os irreversibles en el repositorio y en el sistema.

### ¬øQu√© ofrece?

* Automatizaci√≥n de los respaldos con los archivos y directoriso segu√∫n las condiciones fderotaci√≥n que se especifiquen.

* Rotaci√≥n de los backups con politicas efectivas como guardar un backup de cada d√≠a y las ultimas 4 backups realizados recientemenete del d√≠a actual.

* Chqueos rapidos y profundos automaticos y progranmables para valdiar la integridad de los datos.

* Herramienats en la TUI para cehqueos rapidos, rpofundos y reparaci√≥n del repositorio que cuidan la integridad de los datos.

* Visibilidad inmediata del estado de los respaldos sin necesidad de consultar cientos de logs en intentar entender que est√° bien y que est√° mal, que se respaldo y que no; puedes consultarlo todo en un mismo lugar (panel/TUI).

* Mensajes humanos y accionables que explican qu√© fall√≥ y por qu√© (no c√≥digos cr√≠pticos como error125).

* Una interfaz de usuario en la terminal (TUI), para interactuar cone l sistema con comodidad, cambiar configuraciones, rvisar los estados, ejecutar los programas.

* Capacidad para actuar y corregir desde una sola interfaz: revisar estados, ejecutar acciones y consultar informaci√≥n relevante sin buscar en m√∫ltiples archivos.

* Notificaciones y avisos para que no enterarse del del fallo cuando ya sea demasiado tarde.


---

## 2. Arquitectura del Sistema

### 2.1 Estrategia de Encriptaci√≥n: Eficiencia vs. Complejidad

Para la **versi√≥n inicial**, se ha optado por un sistema **sin encriptaci√≥n de repositorio (Modo `none`)**. Esta decisi√≥n se basa en un an√°lisis de costo-beneficio para el entorno de trabajo actual:

* **Naturaleza de los Datos:** El sistema est√° dise√±ado para respaldar el datos con cambios como los datos en `HOME`, proyectos en curso y archivos que, por s√≠ mismos, no contienen informaci√≥n sensible o ya cuentan con sus propias capas de seguridad.
* **Automatizaci√≥n sin Interrupciones:** La encriptaci√≥n en backups autom√°ticos presenta un dilema de seguridad: o se requiere intervenci√≥n humana constante para introducir la clave, o se guarda la contrase√±a en el sistema (lo cual anula gran parte del beneficio de seguridad).
* **Optimizaci√≥n de Recursos:** Al eliminar la capa de cifrado, reducimos el uso de CPU y aceleramos los procesos de deduplicaci√≥n y compresi√≥n. Esto permite que el backup sea "invisible" para el usuario durante su flujo de trabajo.
* **Entorno Seguro:** El sistema esta pensado para ejecuarse en un entorno seguro y que el destino de los respaldos cuenta con el mismo nivel de restricci√≥n f√≠sica y l√≥gica que los datos originales. No esta pensado para manejar datos sensibles o subir datos a espacios publicos. 

> **Nota:** La arquitectura es flexible. Al basarse en BorgBackup, la transici√≥n a repositorios encriptados en versiones futuras es t√©cnicamente sencilla si los requerimientos de seguridad del entorno lo ameritan.

---

### Casos de Uso Ideales

Este sistema es fundamental para:

1. **Flujos de trabajo intensivos:** Donde cada minuto de avance cuenta (programaci√≥n, dise√±o, redacci√≥n).
2. **Datos Personales Din√°micos:** Fotos, notas y configuraciones que cambian a menudo.
3. **Usuarios que buscan "Paz Mental":** Delegar la tarea repetitiva de la copia de seguridad a un proceso autom√°tico que garantiza que los datos siempre est√©n ah√≠ cuando se necesiten.

---

### El Script Orquestador

Se ejecutar√° mediante un **√∫nico Cron cada 15 minutos**. Su funci√≥n principal es leer las reglas de `backups.conf` y compararlas con el historial en `backups.state`. Toda ejecuci√≥n de BorgBackup se lanzar√° con una prioridad de `nice -n 19`, asegurando que el proceso sea "invisible" para el rendimiento del procesador mientras el PC est√° en uso.

---

### Archivo de Configuraci√≥n (`backups.conf`)

Este archivo es de **solo lectura para el script** y es donde definimos las pol√≠ticas. Al usar formato INI, facilitamos la edici√≥n manual y la organizaci√≥n.

**Ejemplo de estructura:**

```ini
[100] #NO CAMBIAR ESTE ID, 100 siempre es el ID con la informaci√≥n relacionada al repositorio de BorgBackup.
categoria = Repositorio BorgBackup
frecuencia = #N/A
retention = #N/A
rutas = ~/Backups/BorgBackup
compresion = #N/A

[101] #NO CAMBIAR ESTE ID, 101 siempre es el ID del log_file donde se guardan los registros.
categoria = Registros
frecuencia = 2592000 #Cada mes
retention = 12 #Guarda lso registros del ultimo a√±o (12 meses)
rutas = ~/Backups/Logs_BorgBackup
compresi√≥n = N/A Comprime siempre en '.zip' por defecto.

[102] #NO CAMBIAR ESTE ID, 102 siempre es el ID de la configuraci√≥n de chequeo rapidos del repositorio.
categoria = Chequeos Rapidos
frecuencia = 604800 #Cada semana
retention = 52  #Guarda los registros de 1 a√±o (52 semanas)
#compresi√≥n = N/A No comprime los registros por defecto.

[103] #NO CAMBIAR ESTE ID, 103 siempre es el ID de la configuraci√≥n de chequeo prfundo del repositorio.
categoria = Chequeos Profundos
frecuencia = 2592000 # Cada mes
retention = 12  #Guarda los registros de 1 a√±o (12 meses)
#compresi√≥n = N/A No comprime los registros por defecto.

[ 104 - 110 ] #Son reservados para el sistema.


# <=== REGISTROS DEL USUARIO VAN A PARTIR DE ESTE PUNTO (ID 111+) ===>


[Constante] #Primer tarea (sistema asigna el id 111)
frecuencia = 900 #respaldo cada 15 minutos
retencion = --keep-last 4 --keep-daily 7
rutas = /home/user/Lab, /home/user/Work
compresi√≥n = false

[Diario] #Segunda tarea (sistema asigna el id 112)
frecuencia = 86400 #respaldo cada v34 horas
retencion = --keep-daily 7
rutas = /home/user/Archive, /home/user/Work/System
compresi√≥n = false

```
* **El grupo [100]:** Contiene las configuraciones del repositorio para BorgBackup
* **frecuencia, retenci√≥n y compresi√≥n:** Por ahora no tieenen ningun funci√≥n relacionada. Podr√≠a usarse para definir unas politicas generales, pero por ahora solo se escriben por mantener coherencia con el formatod e las dem√°s categorias.
* **rutas:** Ruta del repositorio para BorgBackup

* **El grupo [101]:** Contiene las configuraciones del archivos de registros .log
* **frecuencia:** establece cada cuantos se hace rotaci√≥n y comprension de los registros.
* **retention:** Cantidad maxima de registros comprimidos almacaneados. Es un numero simple (1,10,100).
* **rutas:** Las ruta es donde se guarda los registros.
* **compresi√≥n:** Por defecto siempre se comprimen en formato '.zip'. Los logs contendr√°n muchos patrones repetitivos, para un solo archivo de texto con logs, la compresi√≥ne s rapido y el formato '.zip' es muy compatible con cualquier Sistema, y es rapido. Al comprmirlos se ahorrar√≠a un **porcentaje** de espacio muy cosniderable y siguen siendo faciles de acceder incluso despues de comprimir en '.zip'.

* **El grupo [102](Chequeos Rapidos) y [103](Chequeos Profundos):** Contiene las configuraciones de los chequeos
* **frecuencia:** establece cada cuanto se hace un chequeo del estado del repositorio. Es un numero simple (1,10,100).
* **retention:** Cantidad maxima de registros almacenados sobre los resultados de los chequeos.
* **rutas:** Las ruta es donde se guarda los registros.
* **compresi√≥n:** Por defecto no se comprimen considerando que cada registro ocupa poco espacio. Incluso el comando de chequeo no imprime datos si no encuentra problemas.
rutas = ~/Backups/Checks_BorgBackup

* **Los grupos 104 a 110:** Son grupos reservados para futuras configuraciones del sistema.

**Los grupos del usuario (IDs 111 en adelante)**
* **Grupo [Categoria]:** 
    * La categoria o nombre del grupo se escribe entre corchetes "[]"
    * Puede ser cualquier nombre con caracteres alfanumericos, sin caracteres espaciales (a-zA-Z0-9).
    * Nunca debe tener corchetes DENTRO del nombre que ya esta entre corchetes, por ejemplo: "[ARchivos[101]+]", que puede generar problemas. 
    * Los nombres No deben contener espacios, pero se permite el uso de guines bajos (_) y giones simples (-).
    * Los nombres de cada tarea deben ser unicos, no deben haber 2 tareas con el mismo nombre.
    Si un nombre no cumple con estas condiciones, es omitida toda la tarea y no se procesan sus datos.
* **frecuencia:** Tiempo en segundos entre respaldos.
* **retenci√≥n:** Par√°metros suados en el sistema 'BorgBackup' para la poda autom√°tica de archivos antiguos.
* **rutas:** Rutas de los Directorios y Archivos a respaldar, separados por espacios. Las rutas se escribe igual que como se escribir√≠an en la terminal, con '~' para el home, las rutas con espacios entre comillas: "/tmp/con espacios", o combinado: ~/"con espacios" ('~' dentro de comillas no se expande). 
* **compresi√≥n:** Determina si se comprimen el contenido del backup. Este dato se pasa a BorgBackup que se encarga de hacer la compresi√≥n del backup.


---

#### ¬øC√≥mo se define la retenci√≥n en BorgBackup?

La retenci√≥n (o "poda") se gestiona a trav√©s del comando `borg prune`. Su funci√≥n es analizar todos los backups (snapshots) que existen en el repositorio y decidir cu√°les borrar para ahorrar espacio, bas√°ndose en reglas de tiempo.

**1. Opciones principales de retenci√≥n:**

Borg utiliza prefijos `--keep-` seguidos de un n√∫mero para definir cu√°ntos archivos conservar en diferentes intervalos:

* **`--keep-last N`**: Conserva los √∫ltimos **N** backups realizados, sin importar la fecha.
* **`--keep-daily N`**: Conserva el √∫ltimo backup de cada d√≠a, durante los √∫ltimos **N** d√≠as que hubo actividad.
* **`--keep-weekly N`**: Conserva el √∫ltimo backup de cada semana, por las √∫ltimas **N** semanas.
* **`--keep-monthly N`**: Conserva el √∫ltimo backup de cada mes, por los √∫ltimos **N** meses.
* **`--keep-within INTERVALO`**: Conserva todos los backups dentro de un periodo (ej: `1d` para un d√≠a, `7d` para una semana).

**2. Sintaxis en el script:**

Para mantener la flexibilidad, en el archivo `backups.conf` utilizaremos la **sintaxis nativa separada por espacios**. Esto permite combinar m√∫ltiples reglas para crear una pol√≠tica de retenci√≥n robusta.

* **Ejemplo de pol√≠tica equilibrada:**
`retencion = --keep-daily 7 --keep-weekly 4 --keep-monthly 6`
*Esto guardar√°: los √∫ltimos 7 diarios, 4 semanales y 6 mensuales.*

**3. ¬øPor qu√© usamos la misma sintaxis de Borg?**

* **Sin Traducci√≥n:** El script no tiene que procesar la l√≥gica de "qu√© significa diario"; Borg ya lo sabe.
* **Flexibilidad Total:** Si ma√±ana quieres usar `--keep-yearly`, solo lo escribes en el `.conf` y el script lo aplicar√° autom√°ticamente sin que tengamos que programar nada nuevo.
* **Validaci√≥n Simple:** Como definimos en el **Nivel 4**, solo verificamos que la cadena empiece con `--keep-`.


---

### Archivo de Estado (`backups.state`)

Este archivo es **gestionado autom√°ticamente por el script**. Mantiene la memoria operativa del sistema.

**Ejemplo de estructura:**

```ini
[111]
Categoria = Constantes
ultimo_exito = 1704891600
tiempo_trasncurrido = 902 #(15 minutos con 2 segundos)
tiempo_faltante = -2 #(con frecuencia de cada 15 minutos, se necesita una respaldo hace 2 segundos)/
estado = PENDIENTE #(Requiere backup, pero no ha inciado el proceso de backup o esta en espera de en un backup en PROCESO, (ejm. ID=103))

[112]
Categoria = Diarios
ultimo_exito = 1704891600
tiempo_trasncurrido = 86.505 (1 d√≠a m√°s 105 segundos)
tiempo_faltante = -105 #(con frecuencia de 1 d√≠a, se necesita el respaldo hace 104 segundos)
estado = EN-PROCESO #(el sistema se encuentra realizando el backup con el ID 103, es decir, el grupo actual)

```

* **ID de Secci√≥n:** El script utiliza el ID definido en la configuraci√≥n como cabecera para garantizar la persistencia de los datos.
* **Categoria:** Un dato que no se considera en la logica de los procesos, solo esta ah√≠ p√°ra servir de referencia cuando el usuario revisa el archivo de estados. Este eprmite tener una mejor diea de a que proceso se refiere, en vez de estar teniendo que consultar el ID en el archivo de configuracion.
* **ultimo_exito:** Timestamp Unix del √∫ltimo respaldo √≠ntegro.
* **tiempo_trasncurrido:** `tiempo_trasncurrido = hora actual - ultimo_exito`. 
* **tiempo_faltante:** `tiempo_faltante = `frecuencia_de_actualizaci√≥n - tiempo_trasncurrido`. Si el tiempo flatante es menor o igual 0, el estado debe de ser de PENDIENTE y si el tiempo trasncurrido es mayor 0, el proceso debe de ser REALIZADO.
* **estado:** Sem√°foro de flujo (`REALIZADO`, `PENDIENTE`, `EN-PROCESO`).
* **pid:** Identificador de proceso para monitoreo de actividad y detecci√≥n de fallos.

---

### Sistema de Trazabilidad y Logs

El script utiliza un sistema de registro centralizado mediante la funci√≥n `log_msg()`. Esta l√≥gica prioriza la legibilidad y permite una auditor√≠a r√°pida mediante niveles de severidad y contextos espec√≠ficos.

#### 1. Formato de Registro

Cada entrada en `backups.log` sigue una estructura predecible:
`[FECHA HORA] [NIVEL] [CONTEXTO] : MENSAJE`

#### 2. Definici√≥n de Campos

* **`[FECHA HORA]`**: Marca de tiempo precisa (`YYYY-MM-DD HH:MM:SS`).
* **`[NIVEL]`**: Clasificaci√≥n de la importancia del evento:
* `INFO`: Operaciones normales (inicio de backup, limpieza finalizada).
* `WARN`: Advertencias t√©cnicas o reintentos (ej. falta de notify-send).
* `ERROR`: Fallos en tareas espec√≠ficas (ej. repositorio bloqueado).
* `CRITIC`: Errores del sistema que requieren atenci√≥n inmediata.


* **`[CONTEXTO]`**: Origen de la traza. Puede ser `SYSTEM` para l√≥gica interna o el ID espec√≠fico de la tarea (ej. `ID_101`, `ID_102`).
* **`MENSAJE`**: Descripci√≥n clara de la acci√≥n realizada o del error detectado.

---

#### 3. Salida y Notificaciones

El sistema de logs es inteligente y distribuye la informaci√≥n en tres canales:

1. **Archivo de Registro**: Persistencia en `$LOG_FILE` para auditor√≠as hist√≥ricas.
2. **Consola (TTY)**: Salida coloreada en tiempo real para facilitar la depuraci√≥n visual:
* <span style="color:green">**Verde**</span> para `INFO`.
* <span style="color:yellow">**Amarillo**</span> para `WARN`.
* <span style="color:red">**Rojo**</span> para `ERROR/CRITIC`.


3. **Notificaciones de Escritorio**: (Actualmente en depuraci√≥n) Env√≠o de alertas cr√≠ticas mediante `notify-send` cuando el entorno lo permite.

#### 4. Gesti√≥n de Rotaci√≥n y Resguardos Comprimidos

Para mantener el sistema organziado y liviano, usamos la configuraci√≥n del ID `[101]`:

* **Acci√≥n:** Cuando se cumple la `frecuencia` del log, el script detiene temporalmente cualquier nueva tarea de backup.
* **Compresi√≥n:** Toma el contenido de `backups.log`, lo comprime en un archivo `.zip` y lo mueve a la ruta `log_backups`.
* **Limpieza:** Vac√≠a el archivo `backups.log` (lo deja en 0 bytes) y reanuda la operaci√≥n normal.
* **Retenci√≥n:** Si el n√∫mero de archivos comprimidos supera `log_retention_amount`, elimina el m√°s antiguo.

---

### D. Localizaci√≥n de Componentes (Est√°ndar XDG)

Para que el sistema sea resiliente, organizado, facil de usar y mantener, el script utilizar√° las variables de entorno est√°ndar de Linux basados en el estandar XDG para determinar sus rutas de trabajo. Esto permite tener unas rutas claras y bien definidas para lso archivos esenciales para el funcionamiento y registros d elos backups.

#### 1. Archivo de Configuraci√≥n (`backups.conf`)

* **Ruta:** `$XDG_CONFIG_HOME/backups_manager/backups.conf` (Normalmente `~/.config/backups_manager/`).
* **Raz√≥n (Config):** Es el est√°ndar para datos que el usuario edita manualmente. Al estar aqu√≠, tus reglas de backup se consideran parte del "perfil" del usuario y son f√°ciles de respaldar o versionar.

#### 2. Archivo de Estado (`backups.state`)

* **Ruta:** `$XDG_DATA_HOME/backups_manager/backups.state` (Normalmente `~/.local/share/backups_manager/`).
* **Raz√≥n (Data):** Seg√∫n el est√°ndar, aqu√≠ van los datos persistentes que el programa genera para funcionar pero que el usuario **no debe editar**. Al separarlo de la configuraci√≥n, evitamos que un error de edici√≥n manual en el `.conf` corrompa accidentalmente la memoria operativa del script.

#### 3. Archivo de Registro Activo (`backups.log`)

* **Ruta:** `$XDG_CACHE_HOME/backups_manager/backups.log` (Normalmente `~/.cache/backups_manager/`).
* **Raz√≥n (Cache):** Los logs son datos vol√°tiles que crecen con el tiempo. XDG sugiere que los datos que pueden ser recreados o que son de car√°cter hist√≥rico (como registros de eventos) residan en la cach√©. Esto permite que el sistema identifique estos archivos como "rotables" o "limpiables" si el espacio en disco es cr√≠tico.

---

### E. Resumen de Rutas y Responsabilidades

| Componente | Variable XDG | Ruta por Defecto | Responsabilidad |
| --- | --- | --- | --- |
| **Configuraci√≥n** | `XDG_CONFIG_HOME` | `~/.config/backups_manager/` | **Usuario:** Define rutas, frecuencias e IDs. |
| **Memoria (Estado)** | `XDG_DATA_HOME` | `~/.local/share/backups_manager/` | **Script:** Registra √©xitos y tiempos. |
| **Bit√°cora (Log)** | `XDG_CACHE_HOME` | `~/.cache/backups_manager/` | **Script:** Escribe eventos t√©cnicos en tiempo real. |
| **Repositorio** | *(Personalizada)* | *(Definida en ID 100)* | **Borg:** Almacena los bloques de datos. |
| **Logs ZIP** | *(Personalizada)* | *(Definida en ID 101)* | **Script:** Guarda los registros hist√≥ricos comprimidos. |

---

### F. Herramientas Necesarias (Dependencias)

Antes de iniciar la Fase 1, el script debe validar la existencia de estas herramientas en el `$PATH`. La ausencia de cualquiera de ellas (excepto las opcionales) activar√° un bloqueo de ejecuci√≥n.

#### 1. Herramientas Cr√≠ticas (Sin ellas, el script falla)

* **BorgBackup (`borg`)**: El motor de deduplicaci√≥n y creaci√≥n de snapshots. Es el coraz√≥n del sistema.
* **GNU Coreutils**:
* `date`: Para obtener Timestamps Unix y calcular `tiempo_transcurrido`.
* `mkdir`, `touch`, `rm`: Para la gesti√≥n de directorios y archivos de estado/logs.
* `stat`: Para verificar permisos y tama√±os de archivos de forma precisa.
* `cron`: Para programar la ejecuci√≥n del Script que gestiona los backups.
* `trap`: Para asegurar la ejecuci√≥nd e instrucciones incluso si hayinterrupciones en el sistema.

* **Procesamiento de Texto**:
* `grep` / `sed`: Fundamentales para parsear (leer) los archivos `.conf` y `.state` en formato INI.
* `awk`: Necesario para realizar los c√°lculos matem√°ticos de `tiempo_faltante` y formatear las columnas del log.



* **Herramientas de Gesti√≥n de Logs y Sistema**
* **Zip / Gzip**: (Rotaci√≥n de logs). El script necesita comprimir los archivos `.log` antes de moverlos al hist√≥rico.
* **Utilidades de Proceso**:
* `ps`: Para verificar si el el LOCKFILE del Script Orquestador si es valido.
* `nice`: Para asegurar que el backup corra con prioridad baja y no ralentice el PC.



* **Herramientas de Interfaz (Comunicaci√≥n con el Usuario)**
* **`notify-send`** (libnotify): Para enviar las notificaciones visuales al escritorio (imprescindible si el script corre en segundo plano v√≠a Cron).

### Herramienats del Script TUI (User Interface para la Terminal)
* **`lnav`** Herramienta predefinida para el monitoreo de logs, por su capacidad de b√∫squeda y colores autom√°ticos; si no est√° instalado.
* **`tail`**: Herramienta simple para monotorizar archivos como el de los Logs en tiempo real. Se usar√° como alternativa a `lnav` caundo esta no este presente en el sistema.
* **whiptail** (TUI): Interfaz interactiva de termianl m√°s amigable con el usuario.
* **nano**: Editor de texto usado para cosas como que el usuario edite las configuraciones.


---

## 3. L√≥gica del Sistema:

**Nota de Auditor√≠a:** Para garantizar la trazabilidad total, **cada paso** genera un registro obligatorio. Se utiliza la palabra clave **LOG-LEVEL** para definir la severidad. Todo registro implica escritura en el archivo `.log` e impresi√≥n en terminal (con colores). Las notificaciones visuales (`notify-send`) se emiten en niveles `ERROR` y `CRITIC`, o si se activa el par√°metro `FORZAR_NOTIF`.

---

## 3.1. Fase 1 (Validaciones de Integridad Critica)

Primeras valdiaciones del sistema que eprmiten identificar el estado del sistema y decidir si es fatible continuar el programa con la configuraci√≥n actual.

---

### Nivel -1: Inicializaci√≥n de Canales (Pre-validaci√≥n de Comunicaci√≥n)

Este nivel garantiza que el sistema pueda informar de sus procesos. Si falla, el script no puede registrar errores ni procesos, por lo que aborta inmediatamente.

1. **Validaci√≥n y Activaci√≥n del Archivo de Log:**
* **Acci√≥n:** Comprobar si existe el directorio `~/.cache/backups_manager/`. Si no existe, se crea.
* **Acci√≥n:** Comprobar existencia de `backups.log`.
* **Si existe:** Se verifican permisos de escritura para asegurar la continuidad del registro. **LOG-LEVEL: INFO**.
* **Si no existe:** Se crea el archivo mediante `touch`. **LOG-LEVEL: WARN** (Indica inicio de nueva bit√°cora).


* **Fallo Cr√≠tico:** Si no hay permisos para crear el directorio o escribir en el archivo. **Acci√≥n:** Abortar con error en terminal. **LOG-LEVEL: CRITIC**.


2. **Verificaci√≥n de Capacidades de Comunicaci√≥n (Sem√°foros):**
* **Acci√≥n:** Validar presencia de `notify-send` y sesi√≥n gr√°fica activa (`$DISPLAY` o `$WAYLAND_DISPLAY`).
* **Resultado:** Se definen las variables booleanas `HAS_NOTIFY` y `HAS_DISPLAY`. **LOG-LEVEL: INFO**.



---

### Funci√≥n de Informaci√≥n Unificada (`log_msg`)

**LOG-LEVEL: `none**` (Definici√≥n de herramienta).

Centraliza la salida de datos. Recibe: `NIVEL`, `CONTEXTO`, `MENSAJE` y `FORZAR_NOTIF`.

* **Terminal:** Impresi√≥n inmediata con c√≥digos de color (Verde para INFO, Rojo para ERROR/CRITIC, Amarillo para WARN).
* **Archivo Log:** Escritura con marca de tiempo y contexto.
* **Notificaci√≥n:** Valida si hay herramientas de notificaci√≥n e interfaz grafica activa (HAS_NOTIFY AND HAS_DISPLAY  == true)
   * Si las hay: Ejecuta `notify-send` si `(NIVEL == ERROR|CRITIC OR FORZAR_NOTIF == true)`
   * Si no las hay: No ejecuta nada. **LOG-LEVEL: WARM**.

---

### Nivel 0: Control de Instancia √önica (Lockfile y Gesti√≥n de PIDs)

Previene la corrupci√≥n de datos evitando que dos instancias del script (ej. lanzadas por un Cron solapado) operen simult√°neamente sobre el mismo repositorio o archivo de estado.

1. **La Trampa de Limpieza (`trap`):**
* **Acci√≥n:** Antes de cualquier validaci√≥n, se define: `trap 'rm -f "$LOCKFILE"; exit' EXIT SIGINT SIGTERM`.
* **Raz√≥n:** Garantiza que el archivo de bloqueo se elimine siempre, ya sea por finalizaci√≥n exitosa, interrupci√≥n del usuario (Ctrl+C) o fallo cr√≠tico del sistema (Kill), evitando "falsos positivos" en ejecuciones futuras. **LOG-LEVEL: none**.


2. **Validaci√≥n de Existencia:**
* **Acci√≥n:** Comprobar si existe `$XDG_RUNTIME_DIR/backups_manager.lock`.
* **Si existe:** Se lee el PID interno y se verifica si el proceso sigue activo en el sistema.
* **PID Inactivo:** El archivo es un residuo de un reinicio abrupto. Se elimina. **LOG-LEVEL: INFO**.
* **PID Activo:** Hay una tarea en curso. **Acci√≥n:** Abortar. **LOG-LEVEL: CRITIC**.


* **Si no existe:** El sistema est√° libre. **LOG-LEVEL: INFO**.


3. **Creaci√≥n de Bloqueo:**
* **Acci√≥n:** Se escribe el PID actual (`$$`) en el archivo. **LOG-LEVEL: INFO**.



---

### Nivel 1: Acceso a Archivos de Control (Est√°ndar XDG)

1. **Estructura de Directorios:** Validaci√≥n y creaci√≥n (si no existen) de las rutas base:
* `~/.config/backups_manager/` (Configuraci√≥n).
* `~/.local/share/backups_manager/` (Estado/Memoria).
* **LOG-LEVEL: none** (Definici√≥n de rutas).


2. **Archivo de Configuraci√≥n (`backups.conf`):**
* **Si existe:** Se verifica que sea legible. **LOG-LEVEL: INFO**.
* **Si no existe:** Se crea la plantilla inicial con comentarios gu√≠a para el usuario. **LOG-LEVEL: WARM** (Requiere `FORZAR_NOTIF=true` para indicar al usuario que debe configurar sus rutas).


3. **Archivo de Estado (`backups.state`):**
* **Acci√≥n:** Validaci√≥n o inicializaci√≥n con cabecera t√©cnica. **LOG-LEVEL: INFO**.


4. **Fallo de Acceso:** Cualquier error de permisos en estos puntos detiene el script por seguridad. **LOG-LEVEL: CRITIC**.


---

### Nivel 2: Dependencias (Escaneo de Entorno)

1. **Herramientas Cr√≠ticas:** Escaneo de `borg`, `coreutils`, `cron`, `trap`, `zip`, `ps`, `grep`, `awk`.
* Si faltan: El script no puede garantizar la integridad del backup. **Acci√≥n:** Detener. **LOG-LEVEL: CRITIC**.


2. **Herramientas Opcionales:** Escaneo de `libnotify-bin` (notify-send).
* Si faltan: El script funcionar√° solo en modo texto. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).

**Nota:** Las herramientas implementadas estan especificadas en la secci√≥n de dependencias.

---

### Nivel 3: Infraestructura del Repositorio (ID 100)

1. **Accesibilidad F√≠sica:** Verifica que la ruta del ID 100 exista y sea escribible. **LOG-LEVEL: INFO**.
2. **Integridad Estructural (Borg):** Ejecuta `borg info`.
* **Repositorio V√°lido:** Estructura reconocida. **LOG-LEVEL: INFO**.
* **Directorio Vac√≠o:** Se ejecuta `borg init --encryption=none`. **LOG-LEVEL: WARM** (FORZAR_NOTIF=true).
* **Corrupci√≥n/Error:** Borg no reconoce la carpeta a pesar de tener datos. **LOG-LEVEL: CRITIC**.


3. **Estado de Bloqueo del Repositorio:**
* Verifica si el repositorio est√° bloqueado por otro proceso (o una interrupci√≥n anterior).
* **Acci√≥n:** Si est√° bloqueado, se notifica y aborta para evitar da√±os. **LOG-LEVEL: ERROR**.

---

### Nivel 4: Validaci√≥n de Par√°metros de Log (ID 101)

* Este nivel garantiza que el archivo de bit√°cora (`backups.log`) no crezca indefinidamente, protegiendo el espacio en disco del sistema.
* Aqui se guardan los valores de de los parametros de frecuencia y retenci√≥n, sean valores validos en al configuraci√ìn del usuario, o sean valores de emergencia (30d, 12u). 

1. **Validaci√≥n de Datos:** Comprueba que `frecuencia` y `retencion` sean enteros.
* Si fallan: Se guarda en las variables frecuencia y retencion los valores de emergencia (30 d√≠as = 2.592.000 de frecuencia, 12 archivos de retenci√≥n). **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).

2. **Ruta de Hist√≥ricos:**
* **Ruta V√°lida:** La ruta es real y accesible, Informa y guarda la ruta en la variable de ruta para logs. **LOG-LEVEL: INFO**.
* **Ruta Inv√°lida/Vac√≠a:** 
   * Si la ruta esta especifica, pero el directorio no existe, intenta crearla. 
      * logra crearla y guarda la ruta en la variable. **LOG-LEVEL: WARM**.
      * NO logra crearla. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
   * Si la ruta no esta especifica o no es accesible, informa y no guarda nada.**LOG-LEVEL: WARN** (FORZAR_NOTIF=true).


3. Al final se informan los datos que se usar√°n para los logs (frecuencia, retenci√ìn, ruta). **LOG-LEVEL: INFO**.

---

### Nivel 5: Valdiacione de Par√°metros de los Chequeos (ID 102 y 103)

* Este nivel garantiza que los valores de los chequeos sean correctos y hayan rutas donde registrar los resultados.

1. **Validaci√≥n de Datos:** Comprueba que `frecuencia` y `retencion` sean enteros.
* Si fallan: Se guarda en las variables frecuencia y retencion los valores de emergencia (30 d√≠as = 2.592.000 de frecuencia, 24 archivos de retenci√≥n). **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).

2. **Ruta de Hist√≥ricos:**
* **Ruta V√°lida:** La ruta es real y accesible, Informa y guarda la ruta en la variable de ruta para logs. **LOG-LEVEL: INFO**.
* **Ruta Inv√°lida/Vac√≠a:** 

   * Si la ruta esta especifica, pero el directorio no existe, intenta crearla. 
      * logra crearla y guarda la ruta en la variable. **LOG-LEVEL: WARM**.
      * NO logra crearla. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
   * Si la ruta no esta especifica o no es accesible, informa y no guarda nada.**LOG-LEVEL: WARN** (FORZAR_NOTIF=true).



---

## 3.2. Fase 2 (Filtrado y Procesamiento de Datos)

Esta fase act√∫a como un filtro. Toma la configuraci√≥n bruta del usuario (`backups.conf`), la limpia, aplica valores de seguridad si es necesario y genera una instrucci√≥n v√°lida. Estos datos filtrados se guardan en el archivo de estado (`backups.state`) para ser utilizados posteriormente por Borg.

A diferencia de la fase anterior, esta fase no detiene el script si una tarea falla; simplemente **inhabilita la tarea corrupta** o la **corrige en memoria** para proteger la integridad de los datos y del resto del ciclo.

Los datos procesados corresponden a las categor√≠as de directorios y archivos a respaldar, establecidos en el archivo de configuraci√≥n (`backups.conf`). El manejo de los par√°metros es el siguiente:


### Filtrado incial

Al inciar la Fase 2, se obtienen los IDs de cada tarea establecida en el archivo de configuraciones y para cada tarea se hace lo siguiente:

* Se validan los nombres de los  de los IDs. Solo se permite en los nombres:
    * Valores alfanumericos [a-zA-Z0-9]
    * Guiones simples (-), guiones bajos (_)
    Si un ID no cumple con estas condiciones, no se procesa y se omite. Esto para evitar problemas de procesamiento posterior. Tampoco se sanitizan los nombres, pues luego estos nuevos nombres sanitizados,  no coincidir√≠an con los nombres de las tareas en el archivo de configuraci√≥n.

* Se dividen los IDs entre IDs Unicos y Repetidos: Los IDs Repetidos se informan, pero no se procesan. Los IDs Unicos continuan el proceso.

### Procesamiento de los campos de cada tarea

#### 1. Frecuencia (Sincronizaci√≥n)

* **Regla:** Debe ser un entero positivo.
* **Tratamiento:** Si el valor est√° vac√≠o o no es num√©rico, se aplica el **Valor de Emergencia: 86400** (1 d√≠a).
* **LOG-LEVEL:** `WARN` (FORZAR_NOTIF=true). Informa: "Frecuencia inv√°lida para ID [ID] [Categor√≠a]. Aplicando Valor de Emergencia: 86400".

#### 2. Par√°metros de Retenci√≥n (Poda Inteligente)

El script act√∫a como un filtro de seguridad para evitar que comandos mal formados corrompan la ejecuci√≥n de Borg.

* **Proceso de Limpieza:** (**LOG-LEVEL:** `INFO`)
1. Se descompone la cadena en pares (Par√°metro + Valor).
2. Se comparan los par√°metros contra la **Lista Blanca**: `--keep-last, --keep-hourly, --keep-daily, --keep-weekly, --keep-monthly, --keep-yearly, --keep-within`.
3. Se verifica que cada valor asociado sea un n√∫mero entero.


* **Acci√≥n ante Fallos:**
* **Fallo Parcial:** Si una regla es inv√°lida (ej: `--keep-random 5`), se elimina de la cadena. El script contin√∫a con el resto de opciones v√°lidas. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
* **Fallo Total:** Si despu√©s de la limpieza la cadena queda vac√≠a o el campo original estaba vac√≠o, se aplica la **Pol√≠tica de Emergencia: `--keep-daily 7**`. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).



#### 3. Rutas de Origen (Sanitizaci√≥n de Directorios)

* **Tratamiento:** (**LOG-LEVEL:** `INFO`)
1. Se expanden rutas relativas (ej: `~` a `/home/usuario`).
2. Se eliminan las barras finales (`/`) para garantizar compatibilidad con el est√°ndar de BorgBackup.
3. Se verifica la existencia y lectura de cada ruta.
4. Se guardan las rutas en el archivo de estado, separadas por espacios entre ellas y encerradas entre comillas.


* **Acci√≥n ante Fallos:**
* **Ruta Hu√©rfana:** Si una ruta no existe o no es accesible, se omite de la lista. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
* **Sin Rutas V√°lidas:** Si ninguna ruta es real, la categor√≠a completa **no se transfiere al archivo de estados** para evitar errores en el procesamiento de backups. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).



#### 4. Compresi√≥n (True|False = 0|1)

* **Tratamiento:** El script normaliza la entrada a min√∫sculas.
* **L√≥gica Binaria:** * `true` (en cualquier combinaci√≥n de may√∫sculas)  Se guarda **0** (Activado).
* Cualquier otro valor (o vac√≠o)  Se guarda **1** (Desactivado).


* **LOG-LEVEL:** `INFO` si es v√°lido, `WARN` si el valor era ambiguo y se asumi√≥ `false`.

---

### Archivo de Estado (`backups.state`)

Este archivo es **gestionado autom√°ticamente por el script**. Mantiene la memoria operativa del sistema con los valores filtrados.

**Ejemplo de estructura:**

```ini
[101]
categoria = Registros
ultimo_exito = 1704891600
tiempo_trasncurrido = 2591900
tiempo_faltante = 100
estado = REALIZADO
pid = 0

[102]
categoria = Constantes
frecuencia = 900
retencion = --keep-last 4 --keep-daily 7
rutas = /home/user/Lab /home/user/Work
compresion = 1
ultimo_exito = 1704891600
tiempo_trasncurrido = 902
tiempo_faltante = -2
estado = PENDIENTE
pid = 0

```

* **ID de Secci√≥n:** Utiliza el ID de la configuraci√≥n como cabecera.
* **categoria:** Referencia textual para el usuario.
* **frecuencia:** Valor num√©rico entero (segundos).
* **retencion:** Par√°metros validados para la poda de Borg.
* **rutas:** Rutas absolutas separadas por espacios, sin barra final (`/`).
* **compresion:** `0` para activo (true), `1` para inactivo (false).
* **ultimo_exito:** Timestamp Unix del √∫ltimo respaldo exitoso.
* **tiempo_trasncurrido:** `hora actual - ultimo_exito`.
* **tiempo_faltante:** `frecuencia - tiempo_trasncurrido`. Si es , el estado pasa a **PENDIENTE**.
* **estado:** Sem√°foro de flujo (`REALIZADO`, `PENDIENTE`, `EN-PROCESO`).
* **pid:** Identificador de proceso activo o `0` si est√° inactivo.

---

### L√≥gica de Sincronizaci√≥n (Conf vs. State)

Para cada ID procesado, el script realiza una comparaci√≥n entre los datos nuevos del archivo de configuraci√≥n (`.conf`) y los datos hist√≥ricos del archivo de estado (`.state`).

#### 1. Persistencia de Marcas de Tiempo y Estado

Para evitar que un cambio en la configuraci√≥n reinicie el ciclo de backups, se aplican las siguientes reglas de actualizaci√≥n:

* **Si el ID NO existe en `.state`:** Se crea la secci√≥n desde cero. Se inicializa `ultimo_exito = 0`, `estado = PENDIENTE` y `pid = 0`. **LOG-LEVEL: INFO**
* **Si el ID YA existe en `.state`:** Se actualzan los campos: `categoria`, `frecuencia`, `retencion`, `rutas` y `compresion` siempre se sobrescriben con los valores nuevos procesados en esta fase. **LOG-LEVEL: INFO**

#### 2. Datos que se preservan

Hay datos que se calculan en tiempo de ejecuci√≥n y guardan informaci√≥n critica para el funcionamiento correcto de los backups automaticos. Estos datos no se actualizan respecto al archivo de configuraciones, sino que se actualizan solo en tiempo de ejecuci√≥n. Estos datos son:

* `ultimo_exito` No se tocan, ya que representan la historia y la actividad real del proceso.
* **Estado:** Solo se actualiza si el valor actual es `REALIZADO` y tras el nuevo c√°lculo de tiempos el `tiempo_faltante` resulta  (pasando a `PENDIENTE`). Si el estado es `EN-PROCESO`, se respeta para evitar colisiones.
* `tiempo trasncurrido` y `tiempo faltante` se calculan en en timepo de ejecuci√≥n en base a la hora actual y el `ultimo exito`.

#### 3. Limpieza de Tareas Hu√©rfanas

Si un ID existe en el archivo `.state` pero ha sido eliminado del archivo `.conf` (o ha sido invalidado por no tener rutas reales):

* **Acci√≥n:** El script elimina por completo esa secci√≥n del archivo `.state`. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
* **Raz√≥n:** Mantener el archivo de estado ligero y evitar que el orquestador intente ejecutar tareas que el usuario ya no desea.

### 3. Duplicidad de IDs

* Los IDs Repetidos se omiten y se informa al usuario al omisi√≥n.

* Los IDs sin duplicados se procesan con normalidad.

---

### Formato de Salida de Log (Fase 2 Finalizada)

Al terminar esta sincronizaci√≥n, el script emite un resumen final de la cola de trabajo:




---



## 3.3 Fase 3 (Procesamiento de los datos y creaci√≥n de los backups)

En esta etapa, el script deja de validar y empieza a transformar los estados de las tareas mediante la interacci√≥n con **BorgBackup** y el **Sistema de Archivos**.

### 1. El Algoritmo del Motor de C√°lculos (Pre-Bucle)

Antes de ejecutar, debemos transformar la "memoria" del script (`.state`) en una lista de prioridades.

1. **Lectura de Estados:** Se cargan todos los IDs del archivo `.state`.

2. **Actualzia los estado con respecto al timepo actual:**
Realiza los calculos de los valores asociados a cada ID para usarlos en el programa y actualiza los valores en el `.state`.
* `ahora=$(date +%s)`
* `tiempo_trasncurrido = ahora - ultimo_exito`
* `tiempo_faltante = frecuencia - tiempo_trasncurrido`

3. **Marcado de Estados:**
* Si `tiempo_faltante <= 0` AND `estado == "REALIZADO"` ‚Üí Cambiar a `PENDIENTE`. **LOG-LEVEL: INFO**
* Si `estado == "REALIZADO"` AND `tiempo_faltante > frecuencia` (lleva almenos 1 retraso en 1 back) ‚Üí Notifica el **Retraso** y cambia el estado PENDIENTE. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
* Si `estado == EN-PROCESO` ‚Üí Cambiar a `PENDIENTE`. Esto indica que el proceso se incio, pero algo salio mal. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).
* Si `esatdo` NO tiene como valor ninguno de los estados predefinidos (REALIZADO, PENDIENTE, EN-PROCESO), pasa al estado de PENDIENTE. Esto podr√≠a darse por un error en el proceso, as√≠ que debe ser registrado. **LOG-LEVEL: WARM**

### Ordenamiento 

Se genera una **Cola de Trabajo** ordenada para todos los id con estado en `PENDIENTE` y se ordenan por `tiempo_faltante` (de menor a mayor). Esto asegura que lo m√°s urgente se haga primero. Es de menor a mayar, porquea menor tiempo faltante, mayor es la prioridad, por ejemplo si `tiempo_faltante = -300` significa que hace 300 segundos se debio haber realizado el backup.

### Validaci√≥n de Viabilidad de Espacio

Para prevenir interrupciones cr√≠ticas por falta de almacenamiento, el script realiza un c√°lculo de seguridad antes de invocar a Borg. Se obtiene el tama√±o total de las rutas de origen (sin comprimir) y se compara con el espacio disponible en la partici√≥n del repositorio.

* **Bloqueo de Estado:** Antews de valdiar cualquier ID, actualiza el `.state` con `estado=EN-PROCESO`. **LOG-LEVEL: INFO**

* La regla de validaci√≥n es: **Espacio_Disponible > (Tama√±o_Datos_Origen + 1GB)**

* Sin Factor de Compresi√≥n: Se omite intencionalmente el c√°lculo de compresi√≥n o deduplicaci√≥n. Esto garantiza que el proceso sea exitoso incluso con archivos ya comprimidos (multimedia, cifrados) o en respaldos iniciales donde Borg a√∫n no tiene una base de datos de fragmentos previa.

* Margen de Seguridad (1GB): Este colch√≥n de 1GB protege al sistema operativo de bloqueos por llenado absoluto y permite el crecimiento de los archivos de cach√© y metadatos propios de Borg durante la operaci√≥n.

* Acci√≥n en caso de insuficiencia: Si no se cumple la regla, se registra como LOG-LEVEL: CRITIC, se omite el ID actual para no interrumpir la cola y se contin√∫a con el siguiente ID, que tambi√©bn valida el espacio.

* **Solos e debe hacer 1 backup a la vez y antes haber pasado por la validaci√≥nd e espacio** Se debe hacer 1 a la vez porque quiza en el siguiente ID ya el espacio no sea suficiente, pro eso se debe valdiar el esapcio y procesar los backups 1 a la vez. 

### Ejecuci√≥n del Binomio Borg (Create + Prune)

Luego de verificar la viabilidad de espacio del ID, se procede a crear el backups y hacer limpieza de los backups antiguos.

**Ejecuci√≥n de borg create:** Una vez validado el espacio, se lanza el proceso de respaldo utilizando los flags de compresi√≥n definidos en el perfil de cada ID:

* Compresi√≥n Inteligente (Flag 0): Si el campo compresion == 0, se aplica --compression zstd,6. Este nivel se selecciona por ser el est√°ndar moderno de "punto equilibrado": ofrece una tasa de reducci√≥n superior a gzip con una velocidad de descompresi√≥n comparable a lz4, ideal para uso general.

* Sin Compresi√≥n (Flag != 0): Si el campo compresion tiene cualquier otro valor (t√≠picamente 1), se aplica --compression none.

* Cada que se incia el proceso de creaci√≥n se guarda el log: **LOG-LEVEL: INFO**

**Evaluaci√≥n de Salida ($?):**

* Si `create` da **√âxito (0)** ‚Üí Proceder a `borg prune` usando la cadena de retenci√≥n validada. **LOG-LEVEL: INFO**
   * Si `prune` da **√âxito (0)** ‚Üí Saltar al siguiente ID. **LOG-LEVEL: INFO**
   * Si `create` da **Fallo (!0)** ‚Üí Registrar error, `estado=PENDIENTE`, `pid=0` y saltar al siguiente ID. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).

* Si `create` da **Fallo (!0)** ‚Üí Registrar error, `estado=PENDIENTE`, `pid=0` y saltar al siguiente ID. **LOG-LEVEL: WARN** (FORZAR_NOTIF=true).


---

### Casos Especiales 

Ya que los logs (ID 101) y los chequeos (ID 102 y 103) se manejan de manera distinta a como se manejan las tareas a respaldar (IDs 111+), se crea un caso espacial para el manejo de los logs, que usan unas politicas de retenci√≥n espacial.

#### Manejo de la Bit√°cora (ID 101)

1. **Condici√≥n de Activaci√≥n:** `(tiempo_faltante_ID101 <= 0)`.
2. **Proceso de Rotaci√≥n:**
* Se comprime en `.zip` hacia la ruta definida en el ID 101 y guarda los logs con el nombre `backups_YYYYMMDD.log`. **LOG-LEVEL: INFO**.
* Se aplica la poda: Si hay m√°s de `X` (retenci√≥n) archivos zip, se eliminan los logs del m√°s antigupo al m√°s reciente, hasta que `cantidad_logs == retention_logs`. **LOG-LEVEL: INFO**.
* Se limpia el archivo de logs (backups.log). **LOG-LEVEL: INFO**.

#### Manejo de los chequeos (ID 102 y 103)
1. **Condici√≥n de Activaci√≥n:** `(tiempo_faltante_ID102 <= 0 || tiempo_falt* Se realiza el proceso de chequeo y se registran lso resultados. **LOG-LEVEL: INFO**. Si hay algun error o advertencia se registra, se informa y se valida si el campo de `reparar` es tru o false, es decir, si se aplica o no la reparaci√≥n automatica en estos casos.  **LOG-LEVEL: ERROR**. Si hay errores y las reparacioens se hacen de forma automatica y no se logra hrealziar la reparaci√≥n con exito, se registra y s einforma.  **LOG-LEVEL: CRITIC**.
* Los archivos de registro deben guardarse con un diferenciador para los chequeos rapidos (ID_FAST), un diferenciador para los chequeps profundos (ID_DEEP) y en el caso de los registros de intentos de reparaciones que se realicen se usa otro identificador (ID_FIX) y estos archivos de reparaci√≥n no se rotan ·πïor defecto.
* Se realiza el proceso de chequeo y se registran lso resultados. **LOG-LEVEL: INFO**. Si hay algun error o advertencia se registra **LOG-LEVEL: ERROR**. Si hay errores y las reparacioens se hacen de forma automatica y no se logra hrealziar la reparaci√≥n con exito, se registra y sE informa. **LOG-LEVEL: CRITIC**.


---

## 4. UI, UX y Herramientas de Gesti√≥n

### Notificaciones y Experiencia de Usuario

Para ofrecer una experiencia fluida y evitar la saturaci√≥n de mensajes, el sistema sigue una pol√≠tica de **m√≠nima interrupci√≥n**:

* **Intervenci√≥n Requerida:** Solo se enviar√°n notificaciones emergentes al escritorio (v√≠a `notify-send`) cuando ocurran errores cr√≠ticos que requieran la atenci√≥n inmediata del usuario.
* **Seguridad en Segundo Plano:** El resto de la actividad se registra silenciosamente en los archivos de log. El script detecta si hay una sesi√≥n gr√°fica activa; si no la hay (ejecuci√≥n por cron puro), omite las notificaciones visuales para evitar errores de sistema.

### Panel de Control (Borg-TUI)

Adem√°s del Script Orquestador, se dispone de un programa adicional con un men√∫ interactivo en terminal para gestionar el sistema desde un solo lugar:

* **Monitoreo en Tiempo Real:** El sistema intentar√° abrir **`lnav`** por su capacidad de b√∫squeda y colores autom√°ticos; si no est√° instalado, usar√° **`tail -f`** como alternativa.
* **Gesti√≥n R√°pida:** Opciones para editar la configuraci√≥n de tareas, forzar respaldos inmediatos y consultar el estado de los archivos en el repositorio (ID 100).

#### Arquitectura del Panel

El panel utiliza su propio archivo de configuraci√≥n en `~/.config/backups_manager/backupsTUI.conf` para almacenar par√°metros espec√≠ficos de la interfaz que no pertenecen a la l√≥gica de backups.

#### L√≥gica del Panel

* **Uso de los Logs:** El Panel TUI no solo consulta los logs para mostrarlos al usuario, sino que tambi√©n registra sus propias acciones administrativas en `backups.log` para mantener la trazabilidad.
* **Manejo de Dependencias:** Al inicio, el programa valida herramientas exclusivas de la interfaz (`whiptail`, `lnav/tail`, `nano`) y adem√°s valida nuevamente ptodas las dependencias del script orquestador, con el fin de mostrar al usuario claramente cuanto falta alguna dependencia. La idea es que si el suaurio cuenta con el usuario instala el script TUI, el proceso sea m√°s simple, claro e intuitivo desde la misma TUI.
Podr√≠a consultar las validaciones de dependencias registradas en los logs para simplificar el proceso al sistema, pero no quiero crear mucha dependencia entre ambos scripts para facilitar el mantenimiento y desarrollo de ambos sistemas (orquetador y TUI). Y m√°s cuando el sistema es liviano y esta repetici√≥n de validaciones no a√±ade nimucho codigo, ni a√±ade una necesidad de procesamiento considerable. Lo que si se peude hacer es reutiklizar el codigo de valdiaci√≥n suado en el script orquestador e implementarlo en el script TUI con las validaciones extras necesarias.
* **Configuraci√≥n Inicial:** Si el archivo de configuraci√≥n del panel no existe, se crea autom√°ticamente y solicita al usuario la ruta del script orquestador. Acto seguido, ejecuta el script orquestador que actualiza el sistema y crea los archivos y configuraciones faltantes. Durante la ejecuci√≥n del script orquetador el Panel muestra los Logs que se van generando para de esta manera ser claros con que el script se esta ejecutando y saber que esta ejecutando.
* **Inicio del Programa:** Tras la carga y validaciones, el sistema presenta un resumen del estado actual (√©xitos, fallos y causas) basado en los logs generados por el script orquestador. Luego el Panel despliega el men√∫ de opciones para la interacci√≥n del usuario.

#### Opciones del Usuario

El men√∫ interactivo permite:

1. **Visualizar Registros:** Acceso al monitor de logs en tiempo real (backups.log).
2. **Estado del Sistema:** Resumen de tareas pendientes y ejecutadas (backups.config).
3. **Mantenimiento:** Consultas de integridad y listado del repositorio Borg.
4. **Configurar Tareas:** Apertura del editor para el archivo `.conf` de backups.
5. **Ejecuci√≥n Manual:** Lanzamiento forzado del orquestador.
0. **Salir**

### Mejoras Futuras

Para simplificar el uso a perfiles no t√©cnicos, se planea implementar:

* **Selecci√≥n Visual:** Integraci√≥n con gestores de archivos para a√±adir rutas de respaldo mediante selecci√≥n directa.
* **Formularios Guiados:** Creaci√≥n y edici√≥n de tareas (IDs) mediante asistentes que eliminen la necesidad de editar archivos de texto manualmente.


---

## 5. Instalaci√≥n y Despliegue

El sistema est√° dise√±ado para ser "Portable" y "Auto-instalable":

1. **Bash Alias / Path:** Se recomienda copiar el script orquestador y el scrpt TUI a `~/.local/bin` (programa personal), o en `/usr/local/bin/backup` (programa para todo el sistema y sus usuarios).
2. **Auto-Bootstrap:** Al ejecutarse por primera vez, el script orquetador detectar√° la ausencia de directorios XDG y del archivo `.conf`, crear√° una plantilla b√°sica que le usaurio podr√° llenar segun sus preferencias.
3. **Configuraci√≥n-TUI:** La interfaz TUI al inciarse valida y solicita la ubicaci√≥n el script orquetador para con este reparar y crear las configuraciones y archivos que hagan falta.

3. **Configuraci√≥n del Cron**

#### Automatizaci√≥n con Cron (Programaci√≥n de Tareas)

Si no quieres ejecutar el script manualmente cada vez, puedes usar **Cron**. Cron es un administrador de tareas que funciona en segundo plano en Linux; es como una "alarma" que le dice a tu computadora: *"A tal hora, ejecuta este programa"*.

### A. ¬øD√≥nde se configura?

No se escribe en cualquier parte. Para configurar las alarmas, se debe abrir un archivo especial de configuraci√≥n llamado **Crontab**.

1. Abre una terminal.
2. Escribe el comando: `crontab -e`
3. Si es la primera vez, te preguntar√° qu√© editor usar (Por ejemplo **Nano**, que suele ser la opci√≥n 1).
4. Baja hasta el **final del archivo** y pega tu l√≠nea de programaci√≥n.

Tienes toda la raz√≥n. Esa explicaci√≥n comete un error com√∫n en la documentaci√≥n t√©cnica: lanza un s√≠mbolo (la barra `/`) sin explicar su funci√≥n, lo que genera confusi√≥n.

En `cron`, existen **operadores** que modifican c√≥mo se comportan los n√∫meros. Aqu√≠ tienes una versi√≥n mejorada, mucho m√°s clara y pedag√≥gica, que explica el "porqu√©" de cada s√≠mbolo.

---

### B. ¬øC√≥mo se escribe una tarea? (Versi√≥n Mejorada)

El Crontab utiliza 5 columnas (las "estrellas") para definir el tiempo. Imagina que cada estrella es un filtro que el reloj debe pasar para que el script se ejecute:

```cron
# ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Minuto (0 - 59)
# ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Hora (0 - 23)
# ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ D√≠a del mes (1 - 31)
# ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Mes (1 - 12)
# ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ D√≠a de la semana (0 - 6, 0 es domingo)
# ‚îÇ ‚îÇ ‚îÇ ‚îÇ ‚îÇ
# * * * * * /ruta/al/script.sh

```

#### Los 3 Operadores clave que debes conocer:

1. **El Asterisco (`*`)**: Significa **"todos"**. Si lo pones en la columna de minutos, se ejecutar√° cada minuto de esa hora.
2. **La Coma (`,`)**: Sirve para hacer **listas**. Por ejemplo, `15,45` en la columna de minutos significa: "ejecutar solo en el minuto 15 y en el 45".
3. **La Barra (`/`)**: Se usa para definir **intervalos o pasos**. Es el "cada X tiempo".
* `*/15` significa: "Toma el rango completo (0-59) y ejec√∫talo cada 15 pasos". Es decir: 0, 15, 30 y 45.

#### Ejemplos pr√°cticos explicados:

* **`*/15 * * * *` (Cada 15 minutos)**
* La barra `/` le dice a Cron que no quieres "todos" los minutos, sino saltar de 15 en 15. Es ideal para tu orquestador de backups porque revisa tareas frecuentemente sin saturar el sistema.


* **`0 * * * *` (Al inicio de cada hora)**
* Aqu√≠ no hay barra. Al poner un `0` fijo, le dices: "Espera a que el reloj marque exactamente el minuto 0 de cualquier hora". (Ej: 13:00, 14:00, 15:00).


* **`0 2,14 * * *` (Dos veces al d√≠a)**
* Usamos la **coma** para definir horas espec√≠ficas: las 2:00 AM y las 2:00 PM (14:00).


* **`30 2 * * *` (A una hora fija)**
* Se ejecuta todos los d√≠as a las 2:30 AM exactamente. Es el formato cl√°sico para backups pesados que quieres que ocurran cuando no est√°s usando la PC.

---

### C. La l√≥gica: El "Reloj" vs. la "Frecuencia"

Es vital entender que el Cron y tu archivo de configuraci√≥n de las taraes `.conf`, ambas trabajan juntos, pero tienen funciones distintas:

1. **Cron es el "Despertador":** Solo decide cada cu√°nto tiempo el script "abre los ojos" para mirar si hay trabajo.
2. **El `.conf` es la "Agenda":** Contiene la frecuencia real de tus backups (ej. cada 1 hora, cada 1 d√≠a).

**Escenarios de ejemplo:**

* **Caso 1: Cron cada 15 min | Config con tarea que se realiza cada 1 hora (3600s).**
El script despertar√° 4 veces. En las primeras 3 ver√° que "a√∫n no toca" y se cerrar√° solo. En la cuarta, ver√° que ya pas√≥ la hora y har√° el backup. **(Configuraci√≥n Ideal)**.
* **Caso 2: Cron cada 1 hora | Config cada con tareas que se realiza cada 15 min (900s).**
El script solo despertar√° una vez por hora. Aunque t√∫ quer√≠as backups cada 15 minutos, el script "estuvo dormido" y se perdi√≥ las oportunidades anteriores. **(Configuraci√≥n Incorrecta)**.

---

### D. Recomendaci√≥n para el uso del Cron

Para un equilibrio simple, configura tu Cron en `*/15 * * * * /ruta/al/script.sh`

Esto permite que el sistema revise tareas frecuentemente sin consumir recursos innecesarios. Si tienes backups muy pesados o carpetas con muchos archivos, este margen de 15 minutos le da tiempo al script para validar permisos y espacio en disco antes de que Borg inicie la transferencia.


---

## Licencia

Este proyecto est√° bajo la **Licencia MIT**. Consulta el archivo [LICENSE](LICENSE) para m√°s detalles.

&copy; 2026 **Santiago (kaindev)** - [github.com/kaindev-lab](https://github.com/kaindev-lab)

---
