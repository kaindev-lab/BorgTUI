
# Protocolo de QA: Estrés, Resiliencia y Funcionalidad

**Sistema:** `auto-borgbackups-tui` | **Versión:** `1.0.0-alpha` | **QA Tester:** `kaindev` | **Fecha:** `2026-01-19`

---

## PARTE A: Script Orquestador (`backups.sh`) - 30 Puntos

*Enfoque: Lógica del Sistema, integridad de datos y manejo de errores.*

### A.1. Seguridad de Entorno y Concurrencia (5 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Estado (T/F) | Notas / Observaciones |
| --- | --- | --- | --- | --- | --- |
| **1** | **Permisos Críticos** | `chmod 000` al archivo de configuración y estados. | Aborto inmediato; notificación de error de lectura. | [ T ] |  |
| **2** | **I/O Lock** | Quitar permisos de escritura a Logs. | Aborta de inmediato; notificación de error de lectura.. | [ T ] | El sistema informa mediante la terminal sin dejar registro en los logs a los que no tiene acceso. |
| **3** | **Dependencias** | Simular falta de `borg` (borrar alias o binario). | Fase 1 detecta la ausencia y sale con Código 1. | [ T ] |  |
| **4** | **Race Condition** | Ejecutar dos instancias al mismo segundo. | El `LOCKFILE` bloquea la 2ª instancia; mensaje de aviso. | [ T ] |  |
| **5** | **Zombies / Huérfanos** | Crear `.lock` con PID de un proceso inexistente. | El script limpia el lock antiguo y procede con éxito. | [ T ] | Funciona bien, pero en los logs debería de dar un nivel de WARN, no de INFO para este caso |

### A.2. Robustez del Parser de Configuración (7 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **6** | **Config. Vacía** | Dejar `backups.conf` con 0 bytes. | El script identifica la falta de tareas y termina sin crash. | [ T ] | No identifica la falta de tareas directamente, sino que si esta vacio, identifica la ausencia de la ruta del repositorio y finaliza. Un problema aqui es que parece que si el sistema identifica que existe el archivo de verificación, mientras no este vacio, lo trata con normalidad |
| **7** | **Flags Peligrosos** | Insertar flags de borrado en `retencion`. | El sistema debe filtrar o fallar si el flag es inválido para Borg. | [ T ] |  |
| **8** | **Rutas con Espacios** | `rutas = "~/Mis Documentos/Folder"` | El array en `get_expanded_paths` mantiene los espacios. | [ T ] |  |
| **9** | **Expansión Shell** | Usar variables de entorno en rutas (`$USER`). | El script debe expandir la variable a su valor real. | [ T ] |  |
| **10** | **IDs Corruptos** | Usar IDs alfanuméricos (`[ABC]`) en el `.conf`. | El parser ignora el bloque o lanza error de formato. | [ T ] |  |
| **11** | **Frecuencia Cero** | Poner `frecuencia = 0` en una tarea. | Se trata como "ejecutar siempre" o falla por validación. | [ F ] | El sistema no detecta la frecuencia 0 como una frecuencia invalida. |
| **12** | **Comentarios Sucios** | `compression = True # comentario pegado` | El `sed` debe limpiar el comentario antes de procesar. | [ F ] |  |

### A.3. Inteligencia de Estados y Tiempo (8 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **13** | **Bootstrap Initial** | Ejecutar sin existencia de `.state`. | Creación automática del archivo con valores por defecto. | [ T ] |  |
| **14** | **Precisión Temporal** | Tarea con frecuencia 60s tras 61s de espera. | El script debe pasar de "Omisión" a "Ejecución". | [ F ] |  |
| **15** | **Sincronización ID** | Añadir ID nuevo al medio del `.conf`. | El `.state` debe insertar el nuevo ID sin editar los otros. | [ T ] |  |
| **16** | **Persistencia PID** | Iniciar backup y verificar `pid = XXXX` en `.state`. | El archivo de estado debe reflejar el PID real del proceso. | [ F ] | No veo que el sistema asigne un PID en ningun momento del proceso |
| **17** | **Detección de Crash** | Poner `estado = EN-PROCESO` y un PID inexistente. | Al ejecutar de nuevo el sistema, detecta PID muerto y resetea a PENDIENTE. | [ F ] | Este test no es valido hasta que primero se solucione el problema de que el istema no asigna un PID a las tareas en proceso |
| **18** | **Log de Errores** | Forzar fallo en una tarea (ruta inexistente). | El ID en `.state` debe mostrar el error y volver a PENDIENTE. | [ F ] | Si la ruta no existe, el sistema directaente no incia el proceso del backup, así que el estado no cambia. |
| **19** | **Último Éxito** | Verificar que `ultimo_exito` NO cambia si Borg falla. | El timestamp solo se actualiza si el exit code es 0. | [ V ] | El sistema no pasa a estados, por lo que le ultimo exito no existe en los casos de error |
| **20** | **Loop Infinito** | Simular fecha del sistema en el futuro y volver. | El motor de tiempos debe manejar saltos temporales sin bucles. | [ F ] | El sistema no maneja saltos de tiempos temporales al pasado y se reabilita de un salto temporal al futuro al segundo ciclo del script orquetsador. |

### A.4. Estrés de Datos y Borg (10 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **21** | **Disco Lleno** | Simular falta de espacio en el destino. | Aborto preventivo; log nivel `CRITIC`. | [ F ] | Si existe una validación para esto, pero solo considera como espacio necesario el 1GB de margen, pero el tamaño del directorio o archivo a respaldar no le suma nada del espacio necesario considerado. |
| **22** | **Carga Masiva** | Backup de 10,000 archivos pequeños. | Borg maneja la carga; el scripst no se bloquea por el flujo de log. | [ T ] | Funciona sin problemas |
| **23** | **Interrupción SIGINT** | `Ctrl+C` durante el empaquetado. | Rollback del estado en el archivo `.state` a PENDIENTE. | [ F ] | `Ctr+C` si se procesa, pero solo elimina el PID dek LOCKFILE, no cambia otros valores de proceso. El sistema valida el estado de EN-PROCESO a PENDIENTE con el PID de la tarea que se evalua al incio del analisis de las tareas |
| **24** | **Prune de Precisión** | Ejecutar limpieza en repo con múltiples IDs. | Solo se borran los archivos con el sufijo del ID actual. | [ F ] | La limpieza no se esta ejecutando para ningun ID. |
| **25** | **Compresión** | Activar compresión en una de las tareas. | Borg procesa; script espera el tiempo extra de CPU. | [ V ] |  |
| **26** | **Check de Integridad** | Ejecutar con `borg check` (si se integra). | Detección de repositorios corruptos. | [ F ] | El istema no maneja borg check aún |
| **27** | **Archivos Bloqueados** | Intentar respaldar un archivo abierto por `root`. | Borg lanza aviso; el script termina con `WARN`. | [ T ] |  |
| **28** | **Reintento** | Forzar fallo y esperar al siguiente ciclo Cron. | La tarea debe reintentarse automáticamente. | [ F ] | El sistema no identifica la tarea que nos e realizo. |
| **29** | **Tamaño de Log** | Dejar el log crecer hasta 10MB. | El script sigue escribiendo sin degradación de velocidad. | [ F ] | La degradaciónd e velkocidadsi baja cuando el log llega hasta 10MB o más, aunque la diferencia es poca si es perceptible. |
| **30** | **Finalización Limpia** | Verificar salida de todos los procesos hijos. | No quedan procesos `borg` o `ssh` colgados tras el fin. | [ T ] |  |

---

## PARTE B: Interfaz TUI (`backupsTUI.sh`) - 20 Puntos

*Enfoque: UX, visualización de datos, interacción y estabilidad de terminal.*

### B.1. Interfaz y Navegación (7 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **31** | **Escalado de Terminal** | Redimensionar ventana durante un menú. | Whiptail debe intentar redibujar las ventanas de los menus. | [ T ] |  |
| **32** | **Teclas Especiales** | Probar `Esc`, `Tab` y flechas rápidamente. | Navegación fluida sin carácteres basura en pantalla. | [ T ] |  |
| **33** | **Aislamiento de TTY** | Ejecutar Opción 5 (Manual). | El orquestador toma la TTY y la devuelve limpia al TUI. | [ T ] |  |
| **34** | **Visor de Logs** | Entrar a `lnav` y salir con `q`. | Regreso inmediato al menú principal del TUI. | [ T ] |  |
| **35** | **Input Sanitization** | Meter carácteres raros (`&`, `|`, `;`) en el inputbox. | El script debe tratar el input como texto, no como comando. | [ T ] |  |
| **36** | **Cancelación** | Dar en "Cancelar" en el asistente de ruta. | El script sale con código 1 sin romper archivos de config. | [ T ] |  |
| **37** | **Firma y Versión** | Verificar consistencia de la Opción 6. | Datos coinciden con la documentación oficial. | [ T ] |  |

### B.2. Precisión de la Información (8 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **38** | **Cómputo en Vivo** | Cambiar un valor en `.state` externamente. | El TUI debe reflejar el cambio al recargar el menú. | [ T ] |  |
| **39** | **Alineación de Tabla** | Visualizar tareas con nombres de 20 chars. | La columna de "Estado" debe seguir alineada verticalmente. | [ T ] |  |
| **40** | **Formatos de Tiempo** | Simular un atraso de 1 mes (en segundos). | Debe mostrar "1 mes X sem" y no un número gigante. | [ T ] |  |
| **41** | **Empty State** | Ejecutar TUI con archivos de sistema borrados. | Manejo de errores gráfico (Msgbox informando la falta). | [ T ] |  |
| **42** | **Borg List Stress** | Opción 3 con muchos repositorio que no caben en la ventana. | El `--scrolltext` permite leer todo sin cortar la ventana. | [ T ] | La lista puede verse completa al desplazarse por la venta como el scroll y la flechas del teclado |
| **43** | **Detección de Repo** | Opción 3 con ruta de repo desconectada. | Muestra un error elegante en lugar de un crash de consola. | [ T ] |  |
| **44** | **Logs Recortados** | Dashboard con última línea de log muy larga. | Corte limpio en 70 caracteres para no romper el diseño. | [ T ] | Esta información no aportaba mucho, así que se retiro |
| **45** | **Actualización Manual** | Tras Opción 5, verificar el Dashboard. | El contador de "Realizados" debe subir automáticamente. | [ T ] |  |

### B.3. Resiliencia y Fallos (5 Tests)

| ID | Evaluación | Acción / Procedimiento | Resultado Esperado | Notas / Observaciones | Estado |
| --- | --- | --- | --- | --- | --- |
| **46** | **Editor Externo** | Opción 4, cerrar `nano` con `Ctrl+X` (Sin Cambios) y seleccionar ejecutar cambios. | El script no debe intentar sincronizar si no hubo cambios. | [ F ] | Si le especificas al script que apliqeu cambios, TUI no valida si hubo cambio o no y ejecuta la orden directamente |
| **47** | **Permisos de Script** | Intentar lanzar el TUI con el Script Orquetador sin permisos de ejecución. | El sistema operativo bloquea; el manual explica cómo arreglarlo. | [ F ] | El sistema valida la existencia del script orquestador, pero no valida los permisos |
| **48** | **Señales de S.O.** | Enviar `SIGHUP` a la terminal del TUI. | El TUI debe cerrarse y registrar la salida en su log. | [ F ] | El TUI no se cierra con la señal `SIGHUP` |
| **49** | **Configuración TUI** | Modificar manualmente `backupsTUI.conf` con basura. | El TUI debe detectar el error de ruta y pedir reconfiguración. | [ T ] |  |
| **50** | **Salida Maestra** | Opción 0. | Limpieza total de pantalla (`clear`) y mensaje de cierre. | [ T ] |  |

---

## RESUMEN DE CUMPLIMIENTO

* **Puntaje Total:** `34 / 50`
* **Índice de Resiliencia:** `68 %`
* **Críticos (Fase A) Aprobados:** `17 / 30`
* **UX (Fase B) Aprobados:** `17 / 20`

---

**1. Observaciones de Comportamiento:**

* **Gestión de Procesos Crítica:** El sistema no asigna PIDs a las tareas en el archivo de estados, lo que impide detectar si un proceso se colgó o fue interrumpido, dejando tareas en un estado de "EN-PROCESO" permanente tras fallos.
* **Lógica de Respaldo y Limpieza:** La validación de espacio en disco es insuficiente, ya que solo considera un margen de 1GB sin sumar el tamaño del origen. Además, la función de limpieza (`prune`) no se está ejecutando para ningún ID.
* **Vulnerabilidad Temporal:** El motor de tiempos no maneja saltos hacia el pasado y requiere de varios ciclos para recuperarse de saltos hacia el futuro.
* **Robustez del Parser:** Existe un procesamiento incorrecto de los archivos de configuración cuando contienen comentarios pegados a los valores o cuando el archivo está totalmente vacío.
* **Interfaz TUI:** La experiencia de usuario es muy sólida y visualmente estable, aunque carece de validaciones de permisos de ejecución para el script orquestador y no responde a señales de cierre del sistema como `SIGHUP`.

**Estado Actual:** La aplicación es funcional a nivel de interfaz (Beta), pero el motor lógico presenta riesgos de confiabilidad para un entorno de producción debido a fallos en la persistencia de estados de error como el EN-PRCOESO cuando ocurre un fallo, la valdiación de espacio en disco, gestión de procesos huérfanos, la rotación de backups (limpieza o prune). El sistema puede realizar backups, pero se recomienda unas correcciones esenciales antes de su implementación, como por ejemplo el manejo de procesos huerfanos, rotación de backups (prune) y validacion correcta de espacio en disco antes de realizar el backup.


---

**2. Errores Identificados (ID de Test + Descripción):**

- El sistema no interpreta correctamente los comentarios, lo que hace que los valors de los campos en cada tarea se prosecen mal. Podría por ejemplo hacerse limpieza de comentarios elimianndo todo lo siguiente a los '#' en una lectura que no afecte alk archivo real de configuración y procesar así unas configuracion sin comentariso que el sistema no requiere y no necesita procesar.

- El sistema no valida cuando el archivo de configuracion esta vacio y lo trata con normalidad, por lo que no actua como cuando identifica que no existe y lo crea con valores predeterminados que permiten usar el Sistema con valores predeterminados y se quede cargando el mismo mensaje de error indicando que la ruta del repositorio no esta definida en el .config

- El sistema no asigna el PID en los estados de cada tarea cuando estan en proceso, por lo que no se identifica adecuadamente si un proceso se colgo o se interrumpio antes de terminar el proceso. El sistema no tienen un PID valido con el que el proceso se colgo o es un proceso en ejecución.

- El sistema no reanuda las tareas luego de una salida o error forzado, dejando la tarea en esrtado de EN-PROCESO, lo que quia tenga relación con la asignación y valdiación del PID de cada tarea.

- El sistema no maneja saltos de tiempos temporales al pasado y se reabilita de un salto temporal al futuro al segundo ciclo del script orquetsador. Para solucionar esto, se puede añadir una validación en los calculos temproales, donde se valide que que el tiempo faltante no sea x tiempo mayor a la frecuencia, por ejemplo que si la frecuencia es de 60s y el tiempo faltante calculado es de 3661s (1h con 61s), que el ultimo exito vuleva a 0 (1 de enero de 1970) para que así mientras que el ahora (sea la hora actualzada, pasada o futura) sea despues de esta fecha, el sistema se recuperará. Fechas anteriores a esta podrían dar problemas en el sistema y con algunas herramientas que use el programa.

- La validación de espacio necesario VS espacio disponible en el disco para el repositorio no funciona correctamente, pues considera como espacio necesario el 1GB de margen, pero el tamaño del directorio o archivo a respaldar no le suma nada del espacio necesario considerado. Hay que revisar porque no calcula correctamente el espacio que ocupa el directorio o archivo a respaldar o porque no lo suma a la 1GB de margen de error necesario, comparandolo con el espacio total disponible. El espacio total disponible parece calcularlo bien, epro es algoq eu también es bueno revisar si lo esta calculando correctamente.

- La limpieza (prune) no se esta ejecutando sobre ningun ID, qiza por como esta escrito el prefijo usado para la limpeiza con borg, puede que no encuentre coincidencias y solo sea cambiar el prefijo.

- Parece que la obtrención de datos de cada ID en los estados no tiene un limite bien definido, por ejemplo si la cabecera del sigueinete ID se comenta con algo como: #[ID] pero sus campos no se comentan, hay conflictos en el procesamiento de los datos, por ejemplo en este caso arroja error en el ID-102, en datos como la frecuencia:

"""
[102]
categoria = Prueba1-con-30G
frecuencia = 60
rutas = /home/kaizen/Lab/backups-manager/archivo_real_30G.bin
retencion = --keep-last 3 --keep-daily 7
compression = True

#[103]
categoria = Prueba2-con-1G
frecuencia = 60
rutas = /home/kaizen/Lab/backups-manager/archivo_test_1GB.bin
retencion = --keep-last 3 --keep-daily 7
compression = True

#[104]
categoria = Prueba3-con-10mil-files
frecuencia = 60
rutas = /home/kaizen/Lab/backups-manager/10mil-archivos/
retencion = --keep-last 3 --keep-daily 7
compression = True
"""

- El TUI no se cierra al ejecutar la señal de salida con `Ctr+C`

- Falta integrar borg check en el sistema para validar la integridad de los datos.


---

**3. Mejoras para proximas versiones**

- Usar un NIVEL de log = WARN cuando se detecta un PID huerfano en el LOCKFILE usado para idnetificar cuando hay un script orquetsador ya en proceso.

- La informaciónd e las valdiaciones inciales de los archivos como logs, state, config no es clara. Resuleven los problemas creando y configurando los archivos cuando no existen, pero no regflejan la ausencia d elos archivos en los logs claramente.

- Sería util añadir validaciones para un ID mal escrito en las configuraciones. IDs como [AB100] el sistema los omite, no los procesa, lo que no es un error, pero sería útil para el usuario validaciones y mensajes que le indiquen el error.

- Podría ser aconsejable validar las frecuencias de 0 en las tareas. Estas frecuencias hacen que el sistema haga el proceso de backups y limpieza (prune) cen cada ejecución del script orquetador. Aunque no es necesario quitarlo, podría ser útil avisar de esto en un log.

- El sistema de backups que depende de la ejecución con 'cron' no es preciso. Pueden haber retrasos por ejemplo si hay backups por realizar cada 5 minutos, pero el cron se activa cada hora, la tarea se trasa siempre 11 veces más que la frecuencia asiganda (5 mintos se hacen cada 55 minutos). Para no depender tanto de la configuración del usuario, podríamos convertir el sistema en un 'daemon' que una condigurado, siempre este corriendo en segundo plano y validando cuando es tiempo de ejecutarase.

- Si el sistema detecta si dentro de un directorio a respaldar hay algunas carpetas o archivos a los que no tiene acceso, debería de respaldar el directorio omitiendo los archivos y carpetas a los que tiene acceso y omitir los archivos y carpetas a los que no tiene acceso, pues de 1000 archivos no dbería por ejemplo omitir un backup por 1 solo archivo. Aunque habría que verificar como maneja BorgBackups estos casos, si hace un "todo o nada", o simplemente omite los archivos y directorios a los que no tiene acceso.
 
- La información sobre las tareas que no son validas no es clara en la TUI. La TUI conculta en los estados para mostrar información sobre la tarea, peor en el archivo de estados, solo estan los estados de las tareas validas, por ejemplo una tarea nueva con ritas invaldias, o una tarea vieja que se le cambio las rutas por unas no validas, no estará en el archivo de estados, por lo que las tareas no validas desde el incio o que dejan de ser valdias, en el panel de tareas del TUI no se muestran y para el usuario no será claro por que no se muestran, por lo que es necesario añadir validaciones en el panel del TUI que validen estos casos y a estas tareas invalidas les indique su invalidez, por ejemplo poniendo en el estado algo como: "NO-VALIDA"

- La limpieza (borg prune) no se esta ejecutando para ningun ID. Probablemente tenga relación con el prefix que uso en el 'prune', probablemente por como esta escrito no encuentra coincidencias. Debería añdir valdiaciones extra, no solo validar si hay errores o no durante el prune, sino validar el numero de backups antes y después del prune.

- Añadir la opción de especificar el tipo de compresión para los backups en vez de solo tener un valor predeterminado que se activa o no (True|False).

- Más detallles del repositoprio, por ejemplo usando sus opciones como: `borg info --json repo | jq`, `borg list --long repo`, `borg list repo --format`. También sería adecuado mostrar la compresión del abckups, sea en el listado de los backups, o sea en el nombre con el que se guarda.

- Más detalles en el estado de las tareas, por ejemplo agregar una columna de notas, donde indicar cosas como que se omitieron politicas o rutas que no eran validas. Esto es muy importante para poder saber. También sería util ver los demás datos como las politicas y la frecuencia si esto no hace la caja de infromación demasiado grande. 

- Me gustaría poder seleccionar una tarea especifica y expandir la información sobre esta.

- En la TUI resultaría muy util un submenu, o formulario intemedio antes de lanzar los logs con lnav o tail, donde se filtren los logs que se deseen ver o se indique que opciones ejecutar o que consultas realizar para ver datos especificos como logs de error, de infromación, de advertencia, en vez de ver todos los logs.

- En el panel de la TUI convendría tener en el resumen un conteo de NO-PASAN o algo así, junto a los demás estados. Las tareas sin ubicaciones validas que respladar no pasan a los estados, por lo que no son contadas. Si hay 7 tareas y 1 invalida, en el resumen no debería aparecer que hay 6 tareas, sino 7 tareas y especificar que una no se cuenta, no es valida, no pasa, no se le realiza backups.

- Sería util tener la opción de recarga las ventanas del TUI, para poder cargar nuevos valores, por ejemplo de los estados (PENDIENTE, REALIZADO, EN-PROCESO, TAREAS TOTALES, TAREAS QUE NO PASAN) o por ejemplo en la ventada de estados que cambian con frecuencia.

- Sería util usar una opción que permita ver los estados de las tareas en tiempo real, por ejemplo tener la ventana de estados dentro de un bucle que consulte continuamente los cambios en los estados y en el caso de los datos del tiempo faltante y hora actual (formato UNIX) que calcule los nuevos tiempos que el script orqustador aún no haya actualizado y meustre estos estos tiemos calculados que cuando el script orquestador se activa deberá calcular y quedaran sincronizados en ese momento. Los demás datos como los estados, frecuencia, deberá de estarlos consultando en el archivo. Solo los datos del tiempo se calculan desde el TUI, pues estos no dependen del script orquestador, sino de la hora actual y los valores de frecuencia y uñtimo exito leidos desde el rachivo de estados.

- Crear test de automaticos para testear el sistema rapidamente.

- Dejar claro la licencia bajo la que se usará el proyecto, por ejemplo una licencia MIT ("usa el proyecto como gustes, pero respeta el copyrigth")

- Para que el sistema no se llegue a relentizar cuando se realizan los backups, estos deberían de ejecutarse con el comando nice y con una prioridad baja que no use recursos que el sistema esta suando para otras cosas, así eso implique que los abckups tarden más en realizarse.

**3.1 Mejoras para el test:

- Validar el manejo ante la falta de dependencias NO criticas, solos se valido depencias criticas como 'borg'.

- Validar como actua el sistema cuando las politicas de retención tienen algunas politicas validas y otras invalidas, solo valida cuando que hace el sistema cuando no hay politicas validas.

- Validar como actua el sistema con falta de permisos de acceso sobre los archivos y directorios dentro de un directorio a respaldar definidos en las rutas configuradas por respaldar.

- Validar que el sistema verifique tener permiso de lectura para las rutas a respaldar y todos los archivos y carpetas que este contiene.

- Añadir pruebas sobre el manejo del repositorio cunaod en las ocnfiguraciones no existe, no es accesible o no esta creado.

- Validar el comportamiento del sistema cuando un archivo, un directorio, el contenido de un directorio de una tarea no es accesible (permisos nombre mal escrito).

---

